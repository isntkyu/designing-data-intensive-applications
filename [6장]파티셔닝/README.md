## 파티셔닝

몽고DB, 엘라스틱서치, 솔라클라우드에서는 샤드
HBase 에서는 리전
빅테이블에서는 태블릿
카산드라와 리악에서는 브이노드
카우치베이스에서는 브이버켓

---

### 키-값 파티셔닝

질의가 쏠리는 불균형한 파티션을 핫스팟 이라고 한다.

**키 범위 기준 파티셔닝**

연속된 범위의 키를 할당하여 파티셔닝. 범위 사이의 경계를 알고 파티션을 찾는다.
빅테이블, HBase, 리싱크DB, 2.4 이전버전의 몽고DB에서 사용된다.
각 파티션 내에서는 키를 정렬된 순서로 저장한다. 범위 스캔이 쉽다.

특정 접근 패턴에서는 핫스팟을 유발하는 단점이 있다.
첫 번째 요소로 타임스탬프를 사용하면 동시에 동작하는 요청의 쓰기 부하가 크게 발생할 수 있다.
타임스탬프앞에 이름을 붙여서 파티셔닝하게 하면 된다.

**키 해시값 기준 파티셔닝**

균일 분산에 좋다.
범위 질의에 불리하다. 몽고DB에서 해시 샤딩모드를 사용하면 모든 파티션에 범위질의를 전송해야한다.
리악, 카우치베이스, 볼드모트에서는 기본키 범위질의가 지원되지 않는다.

카산드라에서는 복합 기본키를 지정하여 첫 번째 칼럼을 해싱하고 남은 칼럼은 SS테이블에서 데이터를 정렬하는 인덱스를 사용한다. 첫 번째 칼럼에 고정값만 지정하면 다른 칼럼에 대해서는 범위스캔을 사용할 수 있다. (userId, updatedAt 두 가지를 복합기본키로 지정)

**쏠린 작업 부하와 핫스팟 완화**

해싱을 사용하는 경우에도 완벽히 핫스팟을 제거할 수는 없다.
예를 들어 수백만의 팔로워를 거느린 유명인이 뭔가를 하면 특정 동일한 파티션으로 모든 요청이 쏠리게 된다. 이것 까지 해결하는 방법이나 쏠림을 감지하는 방법(쏠리는 요청을 발견했을 때 키에 임의의 숫자를 붙이기) 등은 다양하지만 개발에 트레이드오프가 있다.

---

### 파티셔닝과 보조 색인

**문서 기준 보조 색인 파티셔닝**

파티션들이 독립적으로 자신의 보조 색인을 유지한다. 그리하여 지역 색인 이라고도한다.

하지만 모든 파티션으로 질의를 보내야한다. 스캐터/개더 방법이라고 한다.

**용어 기준 보조 색인 파티셔닝**

용어에 따라 색인의 파티션이 결정된다.
스캐터/개더 방법 없이 원하는 용어를 포함하는 파티션으로 요청을 보내면 된다.
쓰기가 느리고 복잡하다. 전역 색인이라고 한다.

현실에서는 비동기로 전역 보조 색인이 갱신된다.

---

### 파티션 재균형화

**쓰면 안되는 방법: 해시값에 모드(mod) N연산을 실행**

노드의 개수인 N이 변화하게 되면 지나친 비용이 발생한다.

**파티션 개수 고정**

간단한 해결책.
파티션을 노드 대수보다 많이 만든다.
노드에 간단히 파티션을 추가/제거 할 수 있다.
노드가 추가되면 파티션을 뺏어오고 삭제되면 파티션을 나눠준다.

처음 설정된 파티션ㅇ 개수가 사용 가능한 노드 대수의 최대치가 되므로 충분히 높게 설정해야한다. 미래를 생각해서.

**동적 파티셔닝**

파티션의 수가 전체 용량에 맞춰 조정된다.
그리하여 빈 데이터베이스는 파티션이 한 개로 시작한다는 함정이 있다. 이 문제를 완화하기 위해
HBase, 몽고DB 에서는 초기 파티션 집합을 설정할 수 있는 사전분할이 있다.
몽고2.4 버전부터는 해시파티셔닝에도 동적 파티셔닝을 지원한다. (원래는 키-범위 파티셔닝만)

**노드 비례 파티셔닝**

노드당 할당되는 파티션 개수를 고정한다.
용량에 따라 노드를 늘리면돼서 개별 파티션의 크기는 안정적으로 유지된다.

파티션 경계를 무작위로 설정하는 해시기반 파티셔닝을 사용해야한다.

일관성 해싱의 정의에 가깝게 대응하고 노드나 파티션이 부하에 균등하다.

---

### 요청 라우팅

1. 클라이언트에서 아무 노드에 접속하게 한다. 마침 그 노드에 요청에 맞는 파티션이있다면 수행하고, 아니면 올바른 노드ㅜ로 전달해서 응답을 받고 클라이언트에 전달한다.
2. 모든 요청을 라우팅 계층으로 보내고, 라우팅계층은 각 요청을 처리할 노드를 판별한다.(파티션 인지 로드밸런서 역할)
3. 클라이언트가 파티션 방법을 알고 있게 한다.

클러스터 메타데이터를 추적하기 위해 주키퍼 같은 별도의 코디네이션 서비스를 사용한다.
주키퍼는 신뢰성있는 할당 정보를 관리한다.

카프카나 헬릭스도 파티션을 할당하는데 주키퍼를 사용한다.
몽고DB는 자체 config server에 의존하고 몽고스 데몬을 라우팅 계층으로 사용한다.

카산드라와 리악은 코디네이션 서비스를 사용하지 않는다. 1번 방법 사용.

카우치베이스는 목시라는 라우팅계층을 설정한다.

---

### 정리

> 파티셔닝의 목적은 핫스팟이 생기지 않게 하면서 데이터와 질의 부하를 균일하게 분배하는 것이다.
> 적합한 파티셔닝 방식을 선택하고, 파티션 재균형화를 실행해야 한다.

- 키 범위 파티셔닝 : 키가 정렬 되어 있다. 핫스팟 위험
- 해시 파티셔닝: 고정된 개수의 파티션을 미리 만들거나 동적 파티션을 씀.
- 섞어 쓰기: 파티션식별용 + 정렬순서용으로 복합키를 사용한다. (다이나모디비)

- GSI: 보조 인덱스를 별도로파티셔닝 한다.쓰기 갱신이 어렵지만 읽기가 단일 파티션에서 실행
- LSI: 보조 인덱스를 기본키와 값이 저장된 파티션에 저장한다. 쓸 때는 하나만 갱신. 스캐터/개더 필요함.
